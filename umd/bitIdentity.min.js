!function(t){"function"==typeof define&&define.amd?define(t):t()}(function(){"use strict";function o(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}var c,s,a=a||new Function("try {return this===window;}catch(e){ return false;}"),t=a(),f="14kxqYv3emHGwf8m6YgSYLQkGCvn9Qrgr9",l=" ".repeat(150),p="",g=console.log,e=function(){function t(){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t)}var e,n,r;return e=t,r=[{key:"littleEndian",value:function(t){t.length%2!=0&&(t="0"+t);for(var e="",n=t.length-2;0<=n;n-=2){var r=t.substr(n,2);g(r),e+=r}return e}},{key:"loadScript",value:function(t,e){var n=document.createElement("script");n.type="text/javascript",n.readyState?n.onreadystatechange=function(){"loaded"!=n.readyState&&"complete"!=n.readyState||(n.onreadystatechange=null,e&&e())}:n.onload=function(){e&&e()},n.src=t,document.getElementsByTagName("head")[0].appendChild(n)}},{key:"config",value:function(t){0==t.debug&&(g=function(){}),p=t.filepayKey}},{key:"gentx",value:function(a){var u=this;return new Promise(function(o,i){a.pay.to.forEach(function(t){var e,n;t.protocol&&"bitidentity"==t.protocol.toLowerCase()&&(e=s.PrivateKey.fromWIF(t.value.privateKey),n=s.PublicKey.fromPrivateKey(e),t.data=[f,n.toString(),l],t.pvalue=t.value,t.value=0)}),g(a.pay.to),a.api_key=p,c.build(a,function(t,e){var n,r;e?(g("rawtx1=",e.toString()),n=u.genData2sign(e),g("data2sign="+n),r=s.crypto.Hash.sha256(s.deps.Buffer.from(n)),g("hash="+r.toString("hex")),a.pay.to.forEach(function(t){var e,n;t.protocol&&"bitidentity"==t.protocol.toLowerCase()&&(e=s.PrivateKey.fromWIF(t.pvalue.privateKey),n=s.crypto.ECDSA.sign(r,e).toString(),t.data[2]=n.concat(" ".repeat(150-n.length)),g("signature="+n),delete t.protocol,delete t.pvalue)}),g(a.pay.to),c.build(a,function(t,e){e?(g("data2sign111="+u.genData2sign(e)),g("rawtx="+e.toString()),o(e.toString())):i(t)})):i(t)})})}},{key:"verifyID",value:function(t){var e=s.Transaction(t),n=this.genData2sign(e),r=this.getBitID(e);g(r);var o=s.crypto.Hash.sha256(s.deps.Buffer.from(n));if(0<r.length){for(var i=0;i<r.length;i++){var a=r[i];if(!s.crypto.ECDSA.verify(o,a.sig,a.publicKey))return!1}return!0}return!1}},{key:"getBitID",value:function(t){"string"==typeof t&&(t=s.Transaction(t));var o=[],i=0;return t.outputs.forEach(function(t){var e,n,r=new s.Script.fromBuffer(t._scriptBuffer);r.chunks.length;106==r.chunks[1].opcodenum&&r.chunks[2].buf.toString()==f&&(e=s.PublicKey.fromString(r.chunks[3].buf.toString()),n=s.crypto.Signature.fromString(r.chunks[4].buf.toString()),o.push({publicKey:e,sig:n,pos:i})),i++}),o}},{key:"genData2sign",value:function(t){var n="";return t.inputs.forEach(function(t){n+=t.prevTxId.toString("hex")+t.outputIndex}),t.outputs.forEach(function(t){var e=new s.Script.fromBuffer(t._scriptBuffer);e.chunks.length;106==e.chunks[1].opcodenum&&e.chunks[2].buf.toString()==f?(g("found bitID. PublicKey="+e.chunks[3].buf.toString()),n+=e.chunks[3].buf.toString()+t._satoshis):n+=e.toHex()+t._satoshis}),g("data2sign="+n),n}},{key:"genScriptFromBitbus",value:function(t){for(var e,n="",r=0;r<t.len;r++)if(t["s"+r]){var o=0,i=s.deps.Buffer.from(t["b"+r],"base64").length;if(0<=i&&i<s.Opcode.OP_PUSHDATA1)o=0;else if(i<Math.pow(2,8))o=s.Opcode.OP_PUSHDATA1;else if(i<Math.pow(2,16))o=s.Opcode.OP_PUSHDATA2;else{if(!(i<Math.pow(2,32)))throw new Error("You can't push that much data");o=s.Opcode.OP_PUSHDATA4}o&&(n+=o=o.toString(16));var a=i.toString(16);n+=(a=this.littleEndian(a))+t["h"+r]}else{t["o"+r]&&((e=s.Opcode.fromString(t["o"+r]).toHex()).length<2&&(e="0"+e),n+=e)}return n}},{key:"genData2signFromBitbus",value:function(t){var e=this,n="";return t.in.forEach(function(t){n+=t.e.h+t.e.i}),t.out.forEach(function(t){t.o1&&"OP_RETURN"==t.o1&&t.s2&&t.s2==f?(g("found bitID. PublicKey="+t.s3),n+=t.s3+t.e.v):n+=e.genScriptFromBitbus(t)+t.e.v}),g("bitbus data2sign="+n),n}},{key:"getBitIDFromBitbus",value:function(t){var r=[],o=0;return t.out.forEach(function(t){var e,n;"OP_RETURN"==t.o1&&t.s2==f&&(e=c.bsv.PublicKey.fromString(t.s3),n=c.bsv.crypto.Signature.fromString(t.s4),r.push({publicKey:e,sig:n,pos:o})),o++}),r}},{key:"verifyIDFromBitbus",value:function(t){var e=this.genData2signFromBitbus(t),n=this.getBitIDFromBitbus(t);g(n);var r=null,r=(a(),c.bsv.crypto.Hash.sha256(s.deps.Buffer.from(e)));if(n&&0<n.length){for(var o=0;o<n.length;o++){var i=n[o];if(!c.bsv.crypto.ECDSA.verify(r,i.sig,i.publicKey))return!1}return!0}return!1}}],(n=null)&&o(e.prototype,n),r&&o(e,r),t}();t?e.loadScript("https://unpkg.com/filepay@latest/dist/filepay.min.js",function(){s=c.bsv}):c||(c=require("filepay"),s=c.bsv),t||(module.exports=e)});
